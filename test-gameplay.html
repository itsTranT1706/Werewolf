<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf Gameplay Test</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #4ec9b0; }
    h2 { color: #569cd6; margin-top: 30px; }
    .controls {
      background: #252526;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #1177bb;
    }
    button:disabled {
      background: #3c3c3c;
      cursor: not-allowed;
    }
    .status {
      background: #1e1e1e;
      padding: 10px;
      border-left: 3px solid #4ec9b0;
      margin: 10px 0;
    }
    .log {
      background: #252526;
      padding: 15px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .log-entry {
      padding: 5px;
      margin: 2px 0;
      border-left: 3px solid #858585;
    }
    .log-success { border-left-color: #4ec9b0; }
    .log-error { border-left-color: #f48771; }
    .log-info { border-left-color: #569cd6; }
    .log-warning { border-left-color: #dcdcaa; }
    input {
      background: #3c3c3c;
      border: 1px solid #454545;
      color: #d4d4d4;
      padding: 8px;
      border-radius: 4px;
      margin: 5px;
    }
    .section {
      background: #252526;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    th, td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #3c3c3c;
    }
    th {
      color: #4ec9b0;
    }
  </style>
</head>
<body>
  <h1>üéÆ Werewolf Gameplay Test Suite</h1>
  
  <div class="controls">
    <h2>üîå Connection</h2>
    <div class="status" id="connection-status">Disconnected</div>
    <button onclick="connectSocket()">Connect</button>
    <button onclick="disconnectSocket()">Disconnect</button>
  </div>

  <div class="controls">
    <h2>üéØ Quick Test</h2>
    <input type="text" id="roomId" placeholder="Room ID (auto-generated)" style="width: 300px;">
    <br>
    <button onclick="testStartGame()">1. Start Game (12 players)</button>
    <button onclick="testStartNight()">2. Start Night</button>
    <button onclick="testCupidSelect()">3. Cupid Select</button>
    <button onclick="testWerewolfKill()">4. Werewolf Kill</button>
    <button onclick="testSeerCheck()">5. Seer Check</button>
    <button onclick="testBodyguardProtect()">6. Bodyguard Protect</button>
    <button onclick="testWitchAction()">7. Witch Action</button>
    <button onclick="testEndNight()">8. End Night</button>
    <button onclick="testAnnounceDeaths()">9. Announce Deaths</button>
    <button onclick="testStartDay()">10. Start Day</button>
    <button onclick="testVote()">11. Vote</button>
    <button onclick="testEndVote()">12. End Vote</button>
    <br>
    <button onclick="runFullTest()" style="background: #16825d;">‚ñ∂Ô∏è Run Full Test</button>
    <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
  </div>

  <div class="section" id="roleAssignment" style="display: none;">
    <h2>üìã Role Assignment</h2>
    <div id="roleTable"></div>
  </div>

  <div class="section">
    <h2>üìù Event Log</h2>
    <div class="log" id="log"></div>
  </div>

  <script>
    let socket = null;
    let currentRoomId = null;
    let roleAssignment = [];
    let nightResult = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
    }

    function updateStatus(message, color = '#4ec9b0') {
      const status = document.getElementById('connection-status');
      status.textContent = message;
      status.style.borderLeftColor = color;
    }

    function connectSocket() {
      if (socket?.connected) {
        log('Already connected', 'warning');
        return;
      }

      const token = localStorage.getItem('token');
      const guestId = localStorage.getItem('guest_user_id') || 'test-gm-' + Date.now();
      localStorage.setItem('guest_user_id', guestId);

      socket = io('http://localhost:8080', {
        auth: { token, guestId }
      });

      socket.on('connect', () => {
        updateStatus(`‚úÖ Connected: ${socket.id}`, '#4ec9b0');
        log(`Socket connected: ${socket.id}`, 'success');
      });

      socket.on('disconnect', () => {
        updateStatus('‚ùå Disconnected', '#f48771');
        log('Socket disconnected', 'error');
      });

      // Listen to all events
      socket.onAny((eventName, ...args) => {
        log(`üì® Event: <strong>${eventName}</strong>`, 'info');
        console.log(`Event: ${eventName}`, args);
        
        // Handle specific events
        switch(eventName) {
          case 'GAME_ROLE_ASSIGNMENT_LIST':
            handleRoleAssignment(args[0]);
            break;
          case 'GM_NIGHT_RESULT':
            handleNightResult(args[0]);
            break;
        }
      });
    }

    function disconnectSocket() {
      if (socket) {
        socket.disconnect();
        socket = null;
      }
    }

    function handleRoleAssignment(data) {
      roleAssignment = data.payload.assignment;
      const section = document.getElementById('roleAssignment');
      section.style.display = 'block';
      
      let html = '<table><tr><th>Player</th><th>Role</th><th>Role Name</th><th>Faction</th></tr>';
      roleAssignment.forEach(item => {
        html += `<tr>
          <td>${item.player.username}</td>
          <td>${item.role}</td>
          <td>${item.roleName}</td>
          <td>${item.faction}</td>
        </tr>`;
      });
      html += '</table>';
      
      document.getElementById('roleTable').innerHTML = html;
      log('‚úÖ Received role assignment for ' + roleAssignment.length + ' players', 'success');
    }

    function handleNightResult(data) {
      nightResult = data.payload;
      log(`üìä Night Result: ${nightResult.deaths.length} deaths, ${nightResult.saved.length} saved, ${nightResult.protected.length} protected`, 'success');
    }

    function getRoomId() {
      if (!currentRoomId) {
        currentRoomId = 'test-room-' + Date.now();
        document.getElementById('roomId').value = currentRoomId;
      }
      return currentRoomId;
    }

    function testStartGame() {
      if (!socket?.connected) {
        log('‚ùå Socket not connected!', 'error');
        return;
      }

      const roomId = getRoomId();
      log('üéÆ Starting game...', 'info');

      socket.emit('GAME_START', {
        roomId,
        players: [
          { userId: 'gm1', username: 'GM' },
          { userId: 'p1', username: 'Alice' },
          { userId: 'p2', username: 'Bob' },
          { userId: 'p3', username: 'Charlie' },
          { userId: 'p4', username: 'Dave' },
          { userId: 'p5', username: 'Eve' },
          { userId: 'p6', username: 'Frank' },
          { userId: 'p7', username: 'Grace' },
          { userId: 'p8', username: 'Hannah' },
          { userId: 'p9', username: 'Ivan' },
          { userId: 'p10', username: 'Jack' },
          { userId: 'p11', username: 'Kate' }
        ],
        availableRoles: ['WEREWOLF', 'SEER', 'WITCH', 'BODYGUARD', 'VILLAGER', 'MONSTER_HUNTER']
      });
    }

    function testStartNight() {
      if (!socket?.connected) return;
      log('üåô Starting night...', 'info');
      socket.emit('GM_START_NIGHT', { roomId: getRoomId() });
    }

    function testCupidSelect() {
      if (!socket?.connected) return;
      log('üíò Cupid selecting lovers: Alice ‚ù§Ô∏è Grace', 'info');
      socket.emit('GM_CUPID_SELECT', {
        roomId: getRoomId(),
        lovers: ['p1', 'p7']
      });
    }

    function testWerewolfKill() {
      if (!socket?.connected) return;
      log('üê∫ Werewolf targeting: Bob', 'info');
      socket.emit('GM_WEREWOLF_KILL', {
        roomId: getRoomId(),
        targetUserId: 'p2'
      });
    }

    function testSeerCheck() {
      if (!socket?.connected) return;
      log('üîÆ Seer checking: Alice', 'info');
      socket.emit('GM_SEER_CHECK', {
        roomId: getRoomId(),
        targetUserId: 'p1'
      });
    }

    function testBodyguardProtect() {
      if (!socket?.connected) return;
      log('üõ°Ô∏è Bodyguard protecting: Bob', 'info');
      socket.emit('GM_BODYGUARD_PROTECT', {
        roomId: getRoomId(),
        targetUserId: 'p2'
      });
    }

    function testWitchAction() {
      if (!socket?.connected) return;
      log('üßô‚Äç‚ôÄÔ∏è Witch saving target, not poisoning', 'info');
      socket.emit('GM_WITCH_ACTION', {
        roomId: getRoomId(),
        save: true,
        poisonTargetUserId: null
      });
    }

    function testEndNight() {
      if (!socket?.connected) return;
      log('üåÉ Ending night...', 'info');
      socket.emit('GM_END_NIGHT', { roomId: getRoomId() });
    }

    function testAnnounceDeaths() {
      if (!socket?.connected) return;
      const deaths = nightResult?.deaths || [];
      log(`üíÄ Announcing ${deaths.length} deaths`, 'info');
      socket.emit('GM_ANNOUNCE_DEATHS', {
        roomId: getRoomId(),
        deaths
      });
    }

    function testStartDay() {
      if (!socket?.connected) return;
      log('‚òÄÔ∏è Starting day...', 'info');
      socket.emit('GM_START_DAY', {
        roomId: getRoomId(),
        duration: 120
      });
    }

    function testVote() {
      if (!socket?.connected) return;
      log('üó≥Ô∏è Players voting for Charlie', 'info');
      socket.emit('PLAYER_VOTE', {
        roomId: getRoomId(),
        targetUserId: 'p3'
      });
    }

    function testEndVote() {
      if (!socket?.connected) return;
      log('üìä Ending vote...', 'info');
      socket.emit('GM_END_VOTE', { roomId: getRoomId() });
    }

    async function runFullTest() {
      if (!socket?.connected) {
        log('‚ùå Connect socket first!', 'error');
        return;
      }

      log('üöÄ Starting full automated test...', 'success');
      clearLog();

      await sleep(1000);
      testStartGame();
      
      await sleep(3000);
      testStartNight();
      
      await sleep(1000);
      testWerewolfKill();
      
      await sleep(500);
      testSeerCheck();
      
      await sleep(500);
      testBodyguardProtect();
      
      await sleep(500);
      testWitchAction();
      
      await sleep(1000);
      testEndNight();
      
      await sleep(2000);
      testAnnounceDeaths();
      
      await sleep(1000);
      testStartDay();
      
      await sleep(1000);
      testVote();
      
      await sleep(1000);
      testEndVote();
      
      await sleep(1000);
      log('‚úÖ Full test completed!', 'success');
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // Auto-connect on load
    window.addEventListener('load', () => {
      setTimeout(connectSocket, 500);
    });
  </script>
</body>
</html>
